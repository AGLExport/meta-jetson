From 36161da56075da426fc5f5a25f5838ddb26f2b41 Mon Sep 17 00:00:00 2001
From: wata2ki <wata2ki@gmail.com>
Date: Wed, 13 Apr 2016 23:51:39 +0900
Subject: [PATCH 4/4] Add glFinish to DRM backend to avoid tearing.

---
 Makefile.am          | 1 +
 src/compositor-drm.c | 7 +++++++
 2 files changed, 8 insertions(+)
 mode change 100644 => 100755 Makefile.am

diff --git a/Makefile.am b/Makefile.am
old mode 100644
new mode 100755
index 62719c9..f5e7921
--- a/Makefile.am
+++ b/Makefile.am
@@ -247,6 +247,7 @@ drm_backend_la_LIBADD =				\
 	$(COMPOSITOR_LIBS)			\
 	$(DRM_COMPOSITOR_LIBS)			\
 	$(INPUT_BACKEND_LIBS)			\
+	$(SIMPLE_EGL_CLIENT_LIBS)		\
 	libshared.la -lrt			\
 	libsession-helper.la
 drm_backend_la_CFLAGS =				\
diff --git a/src/compositor-drm.c b/src/compositor-drm.c
index 5059fa1..71d4b81 100755
--- a/src/compositor-drm.c
+++ b/src/compositor-drm.c
@@ -47,6 +47,7 @@
 #include <libudev.h>
 #ifdef HAVE_DRM_TEGRA
 #include <tegra_drm.h>
+#include <GLES2/gl2.h>
 #endif
 
 #include "shared/helpers.h"
@@ -724,6 +725,9 @@ drm_output_repaint(struct weston_output *output_base,
 		output_base->set_dpms(output_base, WESTON_DPMS_ON);
 	}
 
+#ifdef HAVE_DRM_TEGRA
+	glFinish();
+#endif
 	if (drmModePageFlip(backend->drm.fd, output->crtc_id,
 			    output->next->fb_id,
 			    DRM_MODE_PAGE_FLIP_EVENT, output) < 0) {
@@ -847,6 +851,9 @@ drm_output_start_repaint_loop(struct weston_output *output_base)
 	 */
 	fb_id = output->current->fb_id;
 
+#ifdef HAVE_DRM_TEGRA
+	glFinish();
+#endif
 	if (drmModePageFlip(backend->drm.fd, output->crtc_id, fb_id,
 			    DRM_MODE_PAGE_FLIP_EVENT, output) < 0) {
 		weston_log("queueing pageflip failed: %m\n");
-- 
1.9.1

